% **************************************************************************** %
\chapter{Software}
\label{chap:software}
% **************************************************************************** %

Die  Software   unseres  Systems   gliedert  sich   analog  zur   Hardware  in
zwei  prim\"are  Teile: Die   Firmware  des  Sensors  und   die  Software  des
Masters.

In  Abschnitt   \ref{sec:fw:dataFlow}  wird   im  Folgenden   kurz  dargelegt,
wie  diese  beiden  Teilsysteme  konzeptuell  verkn\"upft  sind. Anschliessend
erkl\"art Abschnitt \ref{sec:firmware:sensor}  die Funktionsweise der Firmware
des  Sensors. Die   Software  des   \Raspi  ist  abschliessend   in  Abschnitt
\ref{sec:software:master} dokumentiert.


{\begin{a3pages}
\setlength{\parindentbak}{\parindent}
    \noindent\adjustbox{valign=t}{\begin{minipage}{115mm}
    % ---------------------------------------------------------------------------- %
    \section{Datenfluss}
    \label{sec:fw:dataFlow}
    % ---------------------------------------------------------------------------- %
    Abbilung   \ref{fig:dataFlow}  zeigt   den  Ablauf   der  Spannungs-   und
    Strommessung von den Messsonden bis zur Speicherung der Messergebnisse und
    der zugeh\"origen Metadaten in der Datenbank.

    \setlength{\parindent}{\parindentbak} % restore paragraph indentation
    Die  Spannung  wird in  jedem  PV-Modul  von  einem Sensor  mittels  eines
    analog/digital-Konverters   gemessen. Anschliessend  wird   ein  laufender
    Durchschnittswert  (siehe  dazu  auch Abschnitt  \ref{subs:Sensor},  Seite
    \pageref{subs:Sensor})  zusammen mit  der Serienummer  des Microchips  und
    einer  Checksumme in  ein  Datenpaket gepackt  und  \"uber die  DC-Leitung
    verschickt.

    Die    ON/OFF-Shift   Keying-Schaltung    benutzt    als   Referenz    den
    Clock   eines   separaten,  spannungsgesteuerten   Oszillators   (englisch
    \emph{voltage-controlled oscillator}, VCO).

    Im  \Master~  wird das  Datenpaket  entpackt  und auf  seine  Integrit\"at
    gepr\"uft.   Passt die  Pr\"ufsumme nicht  zu  den Daten,  wird das  Paket
    verworfen. Sind  die Daten  intakt  (bzw. wird  keine Diskrepanz  zwischen
    Pr\"ufsumme und  Daten festgestellt),  werden Spannung und  Serienummer im
    zugeh\"origen Table der Datenbank gespeichert. Zur chronologischen Ordnung
    der Daten wird  noch ein Timestamp abgelegt; damit man  weiss, aus welchem
    Strang das Paket gekommen ist, wird  die Strang-Nummer noch in den Eintrag
    eingef\"ugt.

    Die  Messung der  Strang-Str\"ome  erfolgt direkt  vom  \Master~ aus;  die
    zugeh\"origen Messwerte werden in einem separaten Table abgelegt.

    Zur  Verwaltung  der  installierten  Sensoren  und  PV-Module  wird  f\"ur
    jeden  Strang  ein  Table  gef\"uhrt,  in  dem  die  Serienummern  der  in
    diesem Strang  installierten Sensoren (bzw. deren  Microchips) gespeichert
    sind. Die  Eintr\"age  in  diesen  Tables erfolgen  automatisch,  wenn  in
    einem ankommenden  Datenpaket eine bisher noch  nicht bekannte Serienummer
    detektiert wird.

    \vspace*{40mm}

    \hfill\adjustbox{valign=t}{\begin{minipage}{50mm}
        \figcaption
        [Datenfluss von Messungen bis Speicherung]
        {%
            Datenfluss von den Messungen der Modulspannungen und Strang-Str\"ome bis
            zur Speicherung in der Datenbank%
        }
        \label{fig:dataFlow}
    \end{minipage}}
\end{minipage}}
\hspace*{15mm}
\adjustbox{valign=t}{\begin{minipage}{215mm}
    \input{images/software/dataFlow.tex}
\end{minipage}}
\end{a3pages}}


% ---------------------------------------------------------------------------- %
\section{Firmware \Sensor}
\label{sec:firmware:sensor}
% ---------------------------------------------------------------------------- %
\input{chapters/firmware-sensor.tex}


% ---------------------------------------------------------------------------- %
\section{Software \Master}
\label{sec:software:master}
% ---------------------------------------------------------------------------- %

Es wird  im Folgenden auf  die Software des \Master~  genauer eingegangen. Die
verwendeten  Komponenten  werden beschrieben  und  es  wird auf  die  Lizenzen
ebendieser  Komponenten eingegangen. Anschliessend  werden der  Aufbau unseres
Software-Stacks und die Funktionsprinzipien dokumentiert.


% ---------------------------------------------------------------------------- %
\subsection{Komponenten}
\label{subsec:software:master:components}
% ---------------------------------------------------------------------------- %

Als   Betriebssystem   kommt   Raspbian   zum   Einsatz. Raspbian   ist   eine
Linux-Distribution,  welche auf  Debian  \todo{link auf  website} aufbaut  und
Erweiterungen f\"ur  zus\"atzliche Display-Funktionalit\"at f\"ur  den \Raspi~
besitzt.

Unsere eigene Software basiert auf  Python3 und QT5. In Python3 stehen diverse
Bibliotheken  \todo{welche?} zur  Verf\"ugung,  welche  es uns  erm\"oglichen,
das  Rad  nicht   neu  erfinden  zu  m\"ussen. Sattdessen   k\"onnen  wir  uns
darauf  konzentrieren, die  eigentliche Funktionalit\"at  unseres Ger\"ats  zu
implementieren.

\todo{layering diagramm}

\todo{layering wird hier integriert, kein separater abschnitt}

 - Grundlage für die Software bildet das angepasste Betriebssystem.
 - Darauf aufgebaut sind Programmbibliotheken zur Abstraktion von Betriebsystemfunktionen und weiteren Hardwareaufrufen.
 - Diese werden in der Master-Software eingebunden und mittels Python-API angesprochen.


% ---------------------------------------------------------------------------- %
\subsection{Lizenzen}
\label{subsec:software:master:licenses}
% ---------------------------------------------------------------------------- %

Unterschiedliche konditionen zur Verwendung der Software
 - GPL für Linux kernel
 - Closed Source Firmware Blobs für rpi und display
 - DFSG für alle weitere Software, da von Debian kontrolliert

In Ordung für kommerzielle Zwecke, darf kein Geld verlangt werden
Eigener Quellcode nicht öffentlich und kann als Bestandteil des Produkts verkauft werden.


% ---------------------------------------------------------------------------- %
\subsection{Threads}
\label{subsec:software:master:threads}
% ---------------------------------------------------------------------------- %

 - Hauptthread initialisiert Datenbank und startet Threads, unter welchen die eigentlichen Funktionen aufgeteilt sind.
 - Unterthreads werden mittels Semaphoren vom Hauptthread koordiniert. Dies gewährleistet, dass Arbeitsschritte nur mit aktuellen Daten durchgeführt werden.
 - Geteilte Ressourcen wie die Datenbank und Logging-Funktionalität sind threadsafe.
    - Logging verwendet eine Queue um Anfragen zu speichern und hintereinander abzuarbeiten.
    - Die verwendete Datenbankbibliothek beinhaltet Funkionalität um aus mehreren Threads parallel aufgerufen zu werden. Dazu werden die Anfragen aus jeweils einem Thread gruppiert und atomar ausgeführt.
 - Alle anderen externen Ressourcen, dies sind I2C-bus, UART und GPIO, werden jeweils von nur einem Thread genutzt, wodurch keine Konflikte auftreten können.


% ---------------------------------------------------------------------------- %
\subsection{Aufgabenteilung}
\label{subsec:software:master:taskSeparation}
% ---------------------------------------------------------------------------- %

 - Datensammlung: Empfangen von Spannungs- und Strommesswerte von den Sensoren und abspeichern in der Datenbank.
 - Datenauswertung: Untersuchen der gespeicherten Messwerte auf Defekte Panels
 - Benutzerinterface
   - Graphisch (Display / Touchscreen): Konfigurieren der Einstellungen von Alarmierung und Telefonnummer.
   - Modem (SMS): Versand von SMS beim Eintritt von vordefinierten Ereignissen.
   - Elektrisch (Relais / Tasten): Schalten der eingebauten Relais
 - Datenbankverwaltung: Initialisierung der Datenbank und Vorbereiten der Datenbankverbindung
 - Prozesssteuerung: Verwaltung der einzelnen Threads und ihrem Zustand


% ---------------------------------------------------------------------------- %
\subsection{Benutzeroberfl\"ache}
\label{subsec:software:master:GUI}
% ---------------------------------------------------------------------------- %

% ---------------------------------------------------------------------------- %
\subsection{Datenbank}
\label{subsec:software:master:database}
% ---------------------------------------------------------------------------- %

% ---------------------------------------------------------------------------- %
\subsection{Funktionen}
\label{subsec:software:master:functions}
% ---------------------------------------------------------------------------- %
